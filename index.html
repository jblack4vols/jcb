<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>JCB Reserve Monitor</title>
  <style>
    :root {
      --bg: #0b1020;
      --card: rgba(255,255,255,0.06);
      --card2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --muted2: rgba(255,255,255,0.55);
      --border: rgba(255,255,255,0.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;

      --danger: #ff4d4f;
      --warn: #ffcc00;
      --info: #60a5fa;
      --ok: #34d399;
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      color: var(--text);
      background: radial-gradient(1100px 700px at 15% 15%, rgba(96,165,250,0.18), transparent 60%),
                  radial-gradient(900px 600px at 85% 25%, rgba(52,211,153,0.12), transparent 55%),
                  radial-gradient(900px 600px at 45% 90%, rgba(255,204,0,0.10), transparent 55%),
                  var(--bg);
      min-height: 100vh;
      padding: 24px;
    }

    .container { max-width: 1100px; margin: 0 auto; }
    .header {
      display: flex; gap: 16px; align-items: flex-start; justify-content: space-between; flex-wrap: wrap;
      margin-bottom: 18px;
    }
    h1 { font-size: 22px; margin: 0; letter-spacing: 0.2px; }
    .sub { color: var(--muted); margin-top: 6px; font-size: 13px; line-height: 1.4; }
    .toolbar { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

    .btn {
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: var(--shadow);
      font-weight: 600;
      font-size: 13px;
    }
    .btn:hover { background: rgba(255,255,255,0.10); }
    .btn:active { transform: translateY(1px); }
    .btn.secondary { background: transparent; box-shadow: none; }
    .btn.secondary:hover { background: rgba(255,255,255,0.06); }

    .grid {
      display: grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
    }
    @media (max-width: 920px) {
      .grid { grid-template-columns: 1fr; }
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      box-shadow: var(--shadow);
    }
    .card h2 { font-size: 14px; margin: 0 0 12px; color: var(--muted); font-weight: 700; letter-spacing: 0.25px; text-transform: uppercase; }

    .inputs {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px) { .inputs { grid-template-columns: 1fr; } }

    label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 6px; }
    input {
      width: 100%;
      padding: 12px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline: none;
      font-size: 14px;
    }
    input:focus { border-color: rgba(96,165,250,0.7); box-shadow: 0 0 0 4px rgba(96,165,250,0.16); }

    .metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 620px) { .metrics { grid-template-columns: 1fr; } }

    .metric {
      background: var(--card2);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      min-height: 86px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .metric .k { font-size: 12px; color: var(--muted); }
    .metric .v { font-size: 22px; font-weight: 800; letter-spacing: 0.2px; }
    .metric .s { font-size: 12px; color: var(--muted2); margin-top: 4px; }

    .statusRow {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 12px;
      padding: 12px;
      background: rgba(255,255,255,0.05);
      border: 1px dashed rgba(255,255,255,0.18);
      border-radius: 16px;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      border-radius: 999px;
      padding: 8px 12px;
      font-weight: 800;
      font-size: 12px;
      letter-spacing: 0.4px;
      border: 1px solid rgba(255,255,255,0.18);
      text-transform: uppercase;
    }
    .dot { width: 10px; height: 10px; border-radius: 999px; background: currentColor; opacity: 0.95; }

    .note { font-size: 12px; color: var(--muted); line-height: 1.4; }
    .hr { height: 1px; background: rgba(255,255,255,0.12); margin: 14px 0; border: 0; }

    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; color: var(--muted); }

    .footer {
      margin-top: 14px;
      font-size: 12px;
      color: rgba(255,255,255,0.55);
    }

    .row { display: flex; gap: 10px; flex-wrap: wrap; }
    .row > * { flex: 1; min-width: 200px; }

    .small { font-size: 12px; color: var(--muted2); }
    .right { text-align: right; }

    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.18);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text);
      font-size: 13px;
      box-shadow: var(--shadow);
      opacity: 0;
      transform: translateY(8px);
      transition: opacity 180ms ease, transform 180ms ease;
      pointer-events: none;
    }
    .toast.show { opacity: 1; transform: translateY(0); }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>JCB Reserve Monitor</h1>
        <div class="sub">
          Quick daily liquidity check: total cash, runway, reserve status, and time-to-target.
          <span class="mono">All data stays in this browser (local storage) unless you export it.</span>
        </div>
      </div>
      <div class="toolbar">
        <button class="btn" id="btnSave">Save</button>
        <button class="btn secondary" id="btnLoad">Load</button>
        <button class="btn secondary" id="btnExport">Export JSON</button>
        <button class="btn secondary" id="btnImport">Import JSON</button>
        <button class="btn secondary" id="btnReset">Reset</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>Inputs</h2>

        <div class="inputs">
          <div>
            <label for="operating">Operating Balance</label>
            <input id="operating" type="number" step="0.01" value="9233.50" />
          </div>
          <div>
            <label for="savings">Savings Balance</label>
            <input id="savings" type="number" step="0.01" value="5000.00" />
          </div>
          <div>
            <label for="pinnacle">Pinnacle Balance</label>
            <input id="pinnacle" type="number" step="0.01" value="3837.24" />
          </div>
          <div>
            <label for="avgMonthly">Avg Monthly Expenses (baseline)</label>
            <input id="avgMonthly" type="number" step="0.01" value="60000.00" />
          </div>

          <div>
            <label for="floorTarget">Reserve Floor Target</label>
            <input id="floorTarget" type="number" step="0.01" value="120000.00" />
          </div>
          <div>
            <label for="strongTarget">Strong Target</label>
            <input id="strongTarget" type="number" step="0.01" value="150000.00" />
          </div>

          <div>
            <label for="monthlySurplus">Expected Monthly Surplus (post-refi)</label>
            <input id="monthlySurplus" type="number" step="0.01" value="22000.00" />
          </div>
          <div>
            <label for="monthlyAnchor">Monthly Anchor Payment (1st)</label>
            <input id="monthlyAnchor" type="number" step="0.01" value="9321.03" />
          </div>

          <div>
            <label for="annualTaxes">Annual Property Taxes (for escrow)</label>
            <input id="annualTaxes" type="number" step="0.01" value="40000.00" />
          </div>
          <div>
            <label for="minCashBuffer">Minimum Cash Buffer (extra safety)</label>
            <input id="minCashBuffer" type="number" step="0.01" value="15000.00" />
          </div>
        </div>

        <hr class="hr" />

        <div class="note">
          <b>Status logic</b> is intentionally blunt:
          <ul>
            <li><span class="mono">DANGER</span>: Total cash &lt; 1 month expenses</li>
            <li><span class="mono">STABILIZING</span>: 1 month ≤ cash &lt; Floor target</li>
            <li><span class="mono">REBUILDING</span>: Floor ≤ cash &lt; Strong target</li>
            <li><span class="mono">FORTRESS</span>: cash ≥ Strong target</li>
          </ul>
        </div>
      </div>

      <div class="card">
        <h2>Reserve Dashboard</h2>

        <div class="metrics">
          <div class="metric">
            <div class="k">Total Liquidity</div>
            <div class="v" id="totalCash">$0</div>
            <div class="s" id="totalCashSub">—</div>
          </div>

          <div class="metric">
            <div class="k">Months of Runway</div>
            <div class="v" id="runway">0.00</div>
            <div class="s" id="runwaySub">—</div>
          </div>

          <div class="metric">
            <div class="k">Gap to Floor</div>
            <div class="v" id="gapFloor">$0</div>
            <div class="s">Floor = reserve minimum</div>
          </div>

          <div class="metric">
            <div class="k">Gap to Target</div>
            <div class="v" id="gapTarget">$0</div>
            <div class="s">Target = “distributions allowed” zone</div>
          </div>

          <div class="metric">
            <div class="k">Monthly Tax Escrow</div>
            <div class="v" id="taxEscrow">$0</div>
            <div class="s">Annual taxes / 12</div>
          </div>

          <div class="metric">
            <div class="k">Months to Strong Target</div>
            <div class="v" id="monthsToTarget">—</div>
            <div class="s">Using expected monthly surplus</div>
          </div>
        </div>

        <div class="statusRow">
          <div class="row" style="align-items:center;">
            <div>
              <div class="badge" id="statusBadge"><span class="dot"></span><span id="statusText">—</span></div>
              <div class="small" id="statusHint" style="margin-top:8px;">—</div>
            </div>
            <div class="right" style="min-width: 240px;">
              <div class="small">Available above protected base</div>
              <div class="v" style="font-size:20px;" id="availableAboveBuffer">$0</div>
              <div class="small" id="distributionRule">—</div>
            </div>
          </div>
        </div>

        <div class="footer">
          Tip: click <b>Save</b> after updates. This is a lightweight “truth panel” for JCB liquidity —
          not a full forecast engine.
        </div>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept="application/json" style="display:none;" />
  <div class="toast" id="toast">Saved.</div>

  <script>
    const $ = (id) => document.getElementById(id);

    const fields = [
      "operating","savings","pinnacle","avgMonthly",
      "floorTarget","strongTarget","monthlySurplus","monthlyAnchor",
      "annualTaxes","minCashBuffer"
    ];

    function n(v) {
      const x = Number(v);
      return Number.isFinite(x) ? x : 0;
    }
    function money(x) {
      const v = n(x);
      return v.toLocaleString(undefined, { style: "currency", currency: "USD" });
    }
    function fixed(x, digits=2) {
      const v = n(x);
      return v.toFixed(digits);
    }

    function statusFor(totalCash, avgMonthly, floor, strong) {
      if (totalCash < avgMonthly) return { key: "DANGER", color: "var(--danger)", hint: "Below 1 month runway. Freeze non-essentials; protect debt service timing." };
      if (totalCash < floor)      return { key: "STABILIZING", color: "var(--warn)",   hint: "Above 1 month runway but below floor. No distributions; rebuild reserves." };
      if (totalCash < strong)     return { key: "REBUILDING", color: "var(--info)",   hint: "Above floor. Rebuild toward strong target before discretionary moves." };
      return { key: "FORTRESS", color: "var(--ok)", hint: "Above strong target. Distributions allowed *down to the floor*." };
    }

    function compute() {
      const operating = n($("operating").value);
      const savings   = n($("savings").value);
      const pinnacle  = n($("pinnacle").value);

      const avgMonthly = Math.max(1, n($("avgMonthly").value));
      const floor      = n($("floorTarget").value);
      const strong     = n($("strongTarget").value);
      const surplus    = n($("monthlySurplus").value);
      const anchor     = n($("monthlyAnchor").value);
      const annualTax  = n($("annualTaxes").value);
      const buffer     = n($("minCashBuffer").value);

      const totalCash = operating + savings + pinnacle;
      const runway = totalCash / avgMonthly;

      const gapFloor = floor - totalCash;      // positive = under floor
      const gapTarget = strong - totalCash;    // positive = under target

      const taxEscrow = annualTax / 12;

      let monthsToTarget = "—";
      if (surplus > 0 && gapTarget > 0) monthsToTarget = fixed(gapTarget / surplus, 1);
      if (gapTarget <= 0) monthsToTarget = "0.0";

      const st = statusFor(totalCash, avgMonthly, floor, strong);

      // Protected base: floor + cash buffer + next month anchor payment + monthly tax escrow
      const protectedBase = floor + buffer + anchor + taxEscrow;
      const available = totalCash - protectedBase;

      $("totalCash").textContent = money(totalCash);
      $("totalCashSub").textContent = `Operating ${money(operating)} • Savings ${money(savings)} • Pinnacle ${money(pinnacle)}`;

      $("runway").textContent = fixed(runway, 2);
      $("runwaySub").textContent = `Based on avg monthly expenses ${money(avgMonthly)}`;

      $("gapFloor").textContent = money(gapFloor);
      $("gapTarget").textContent = money(gapTarget);

      $("taxEscrow").textContent = money(taxEscrow);
      $("monthsToTarget").textContent = monthsToTarget;

      const badge = $("statusBadge");
      badge.style.color = st.color;
      $("statusText").textContent = st.key;
      $("statusHint").textContent = st.hint;

      $("availableAboveBuffer").textContent = money(available);

      const distRule = $("distributionRule");
      if (totalCash >= strong) {
        distRule.textContent = `Distribution allowed down to floor (${money(floor)}).`;
      } else {
        distRule.textContent = `No distributions until ≥ strong target (${money(strong)}).`;
      }
    }

    function getState() {
      const state = {};
      for (const f of fields) state[f] = n($(f).value);
      state._savedAt = new Date().toISOString();
      return state;
    }

    function setState(state) {
      for (const f of fields) {
        if (state[f] !== undefined) $(f).value = state[f];
      }
      compute();
    }

    function toast(msg) {
      const t = $("toast");
      t.textContent = msg;
      t.classList.add("show");
      setTimeout(() => t.classList.remove("show"), 1400);
    }

    // Events
    for (const f of fields) $(f).addEventListener("input", compute);

    $("btnSave").addEventListener("click", () => {
      localStorage.setItem("jcbReserveMonitor:v1", JSON.stringify(getState()));
      toast("Saved.");
    });

    $("btnLoad").addEventListener("click", () => {
      const raw = localStorage.getItem("jcbReserveMonitor:v1");
      if (!raw) return toast("No saved data found.");
      try { setState(JSON.parse(raw)); toast("Loaded."); }
      catch { toast("Load failed (bad JSON)."); }
    });

    $("btnExport").addEventListener("click", () => {
      const blob = new Blob([JSON.stringify(getState(), null, 2)], { type: "application/json" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = "jcb-reserve-monitor.json";
      a.click();
      URL.revokeObjectURL(a.href);
    });

    $("btnImport").addEventListener("click", () => $("fileInput").click());
    $("fileInput").addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      try {
        const text = await file.text();
        setState(JSON.parse(text));
        toast("Imported.");
      } catch {
        toast("Import failed.");
      } finally {
        e.target.value = "";
      }
    });

    $("btnReset").addEventListener("click", () => {
      localStorage.removeItem("jcbReserveMonitor:v1");
      toast("Reset saved data.");
    });

    // Initial compute on load
    compute();
  </script>
</body>
</html>
